<script src="/audiojs/audio.min.js"></script>
<script>
	audiojs.events.ready(function() {
		var as = audiojs.createAll();
	});
</script>
<div class="container-responsive">
	<div class="page-header">
		<h1>:: I am your father <small><%= t('.hello') %>!, expand your family!</small></h1>
	</div>
	<div class="row">
		<div class="col-xs-12 col-sm-8 col-md-8 col-lg-9">
			<div class="sigma-parent" id="sigma-example-parent">
				<div class="sigma-expand" id="sigma-example"></div>
			</div>
		</div>
		<div class="col-xs-12 col-sm-4 col-md-4 col-lg-3" id="dashboard">
			<div class="panel panel-<%=%w[info warning success danger primary].sample-%>">
				<div class="panel-heading">Dashboard</div>
				<div class="panel-body">

					<h2>I am <%=@user.username-%></h2>
					<%if @facebook_login%>
						<%=link_to "Sign out", signout_path, id: "sign_out", class:"btn" %>
					<%else%>
						<%= link_to "Facebook Login", "/auth/facebook", id: "sign_in", class:"btn" %>
					<%end%>
					<h2>Point : <%=@user.point-%></h2>
					<button id="independance">Independance</button>
					<button id="betray">Betray</button>
					<button id="seize">Seize</button>
					<h2>Friend List</h2>
					<table class="table table-striped">
						<thead>
							<tr>
								<th>#</th>
								<th>Friend Name</th>
								<th>Point</th>
								<th>State</th>
							</tr>
						</thead>
						<tbody id="friends_list">
					</tbody>
					</table>
					<center>
						<ul id="friends_pagination" class="pagination">
							<li><a href="#">«</a></li>
							<li><a href="#">1</a></li>
							<li><a href="#">2</a></li>
							<li><a href="#">3</a></li>
							<li><a href="#">4</a></li>
							<li><a href="#">5</a></li>
							<li><a href="#">»</a></li>
						</ul>
					</center>
				</div>
			</div>
		</div>
	</div>
	<div id="dialog">
		<div class="row-fluid">
			<div class="span10">
				<span id="dialog_title">title</span>
			</div>
			<div class="span2">
				<a href="#" onclick='$("#dialog").hide()'>X</a><br>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span6">
				<img id="dialog_image" src="">
			</div>
			<div class="span6">
				<h1><span id="dialog_name">Username</span></h1>
				<h1><span id="dialog_banner">Banner</span></h1>
				<h1><span id="dialog_point">Point</span></h1>
			</div>
		</div>
		<div id="dialog_button" class="row-fluid">
		</div>
	</div>

<script type="text/javascript">
	var node_id = null;
	var nodes = null;
	var groups = null;
	var function_type = null; //type : null, betray, seize
	var friends_list = {}
	var friends_cnt = 0
	var friends_cnt_per_page = 5
	var limit_page = 0;

	const BETRAY = 1;
	const SEIZE = 2;

	$(function(){
		groups = <%=@groups%>;
		//console.log(groups);
		$("#dialog").hide();
		<%=render :partial => 'map/friends'%>
		
		<%=render :partial => 'map/node_click_event'%>

	});

	function init() {
		// Instanciate sigma.js and customize rendering :
		var sigInst = sigma.init(document.getElementById('sigma-example')).drawingProperties({
			defaultLabelColor: '#fff',
			defaultLabelSize: 14,
			defaultLabelBGColor: '#fff',
			defaultLabelHoverColor: '#000',
			labelThreshold: 6,
			defaultEdgeType: 'curve'
		}).graphProperties({
			minNodeSize: 1,
			maxNodeSize: 7,
			minEdgeSize: 1,
			maxEdgeSize: 1,
		}).mouseProperties({
			maxRatio: 20,
		});

	// Parse a GEXF encoded file to fill the graph
	// (requires "sigma.parseGexf.js" to be included)
		sigInst.parseGexf('data/data.gexf');

	// Bind events :
		sigInst.bind('overnodes',function(event){
			var neighbors = {};
			var index = null;
			node_id = parseInt(event.content[0])
			for(i=0;i<groups.length;i++){
				if(groups[i].indexOf(node_id)>=0){
					index = i;
					break;
				}
			}

			if(index == null)
				nodes = [];
			else
				nodes = groups[index];

			sigInst.iterEdges(function(e){
				if(nodes.indexOf(parseInt(e.source))>=0 || nodes.indexOf(parseInt(e.target))>=0){
					neighbors[e.source] = 1;
					neighbors[e.target] = 1;
					//console.log(e.source)
				}
				}).iterNodes(function(n){
					if(!neighbors[n.id] && n.id != nodes ){
					//Edit by susang
					n.hidden = 0;
					n.color = change_alpha(n.color, "0.2")
					}else{
					n.hidden = 0;
					}
				}).draw(2,2,2);
			}).bind('outnodes',function(){
				sigInst.iterEdges(function(e){
					e.hidden = 0;
				}).iterNodes(function(n){
				//Edit by susang
					n.hidden = 0;
					n.color = change_alpha(n.color, "1.0")
				}).draw(2,2,2);
				nodes = null
			})
			// Draw the graph :
			sigInst.draw();
		}

		if (document.addEventListener) {
			document.addEventListener("DOMContentLoaded", init, false);
		} else {
			window.onload = init;
		}

	//chage rbga alpha

	function change_alpha(color_string, a_value){
		var c = color_string.toString()
		var str = c.substr(0, c.length-5) + "," + a_value + ")"
		return str

	}

	function dialog_yes(function_type){
		$.ajax({
			url: "/map/"+function_type,
			type: "POST",
			data: {
				user_id: node_id // if user_id == 0 then get session user
			},
			success: function(data) {
				alert(function_type +" complete");
				location.reload(true);
			}
		});
	}

	function dialog_no(function_type){
		$("#dialog").hide();
	}
	function friends_page(num){
		var start = friends_cnt_per_page * (num - 1)
		var end = friends_cnt_per_page * num ; 
		var html =""
		for(i=start;i<end;i++){
			if(i >= friends_cnt){
				break;
			}
			html += "<tr>\n"
				+ "<td><img src='" + friends_list[i]["pic"] + "' class='friend_pic'></td>\n"
				+ "<td><a href='" + friends_list[i]["uid"] + "'>" + friends_list[i]["name"] + "</td>\n"
			if(friends_list[i]["joined"] == true){
				html += "<td>" + friends_list[i]["point"] + "</td>\n"
				//TODO change this
							//+ "<td>Joined</td>\n";
					+ '<td><a href="/auth/facebook" onclick="invitation(' + friends_list[i]["uid"] + ')" class="btn">Invite</a>'
			}else{
				html += "<td>-</td>\n"
					+ '<td><a href="/auth/facebook" onclick="invitation('+friends_list[i]["uid"] + ')" class="btn">Invite</a>'
			}

			html += "</tr>\n"
		}

		$("#friends_list").html(html);
	}

	function friends_pagination(page_num){

		var limit = 5
		var start = limit * (page_num - 1) + 1
		var cnt = parseInt(friends_cnt / friends_cnt_per_page + 0.99)
		var end = limit * page_num
		var html = ""

		html += "<li><a href='#' onclick='friends_pagination("+(page_num-1)+")'>«</a></li>"
		for(i=start;i<=end;i++){
			if(i >= cnt)
				break;
			html += "<li><a href='#' onclick='friends_page("+ i +");'>" + i + "</a></li>"
		}

		html += "<li><a href='#' onclick='friends_pagination("+(page_num+1)+")'>»</a></li>"
		$("#friends_pagination").html(html);
		friends_page(start);
	}

	function invitation(uid){
		alert(uid)
		$.ajax({
			url: "/data/send_invitation",
			type: "POST",
			data: {
				uid: uid
			},
			success: function(friends) {
				alert(data)
			}
		});
	}

</script>

<style type="text/css">
	/* sigma.js context : */
	.sigma-parent {
		position: relative;
		border-radius: 4px;
		-moz-border-radius: 4px;
		-webkit-border-radius: 4px;
		background: #222;
		background-image: url('/img/background.png');
		height: 600px;
	}
	.sigma-expand {
		position: absolute;
		width: 100%;
		height: 100%;
		top: 0;
		left: 0;
	}
	.buttons-container{
		padding-bottom: 8px;
		padding-top: 12px;
	}
	#dialog{
		position: absolute;
		left: 50px;
		top: 50px;
		width: 300px;
		height: 300px;
		background-color:blue;
	}
	.audiojs{
		display:none;
	}
	.friend_pic{
		width:40px;
		height:40px;
	}
</style>
<audio src="/sound/starwars.mp3" preload="auto" autoplay="autoplay" loop="loop" style="width:0" />

